<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Share</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
        }

        header h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #00a8cc);
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: #fff;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            transform: translateY(-3px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .setting-group {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 14px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 10px;
            color: #aaa;
            font-size: 13px;
            text-transform: uppercase;
        }

        .setting-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }

        .setting-group select option {
            background: #1a1a2e;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }

        .checkbox-wrapper input {
            width: 22px;
            height: 22px;
            accent-color: #00d9ff;
        }

        .link-box {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .link-box input {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.4);
            color: #00d9ff;
            font-size: 14px;
            font-family: monospace;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            aspect-ratio: 16/9;
            max-height: 70vh;
        }

        #remoteVideo, #localVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .status {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #888;
        }

        .status.connected { color: #00ff88; }
        .status.error { color: #ff4757; }
        .status.warning { color: #ffa502; }

        .room-id-display {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px 25px;
            border-radius: 12px;
            display: inline-block;
            margin: 10px 0;
            font-family: monospace;
            font-size: 28px;
            letter-spacing: 4px;
            color: #00d9ff;
            border: 2px dashed rgba(0, 217, 255, 0.3);
            user-select: all;
        }

        .viewers-count {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(0, 255, 136, 0.2));
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin: 15px 0;
        }

        .join-panel {
            text-align: center;
            padding: 50px 20px;
        }

        .join-panel h2 {
            margin-bottom: 30px;
        }

        .join-panel input {
            padding: 18px 25px;
            font-size: 24px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            width: 320px;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-family: monospace;
        }

        .join-panel input::placeholder {
            letter-spacing: 2px;
            font-size: 16px;
            text-transform: none;
        }

        .tabs {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .tab {
            padding: 18px 40px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(0, 255, 136, 0.1));
            border-color: #00d9ff;
        }

        .tab:hover {
            background: rgba(0, 217, 255, 0.1);
        }

        .hidden { display: none !important; }

        .fullscreen-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: #fff;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            z-index: 10;
            font-size: 18px;
        }

        .stats-box {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 12px;
            font-family: monospace;
            z-index: 10;
        }

        .stats-box div { margin: 5px 0; }

        .quality-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .quality-good { background: #00ff88; }
        .quality-medium { background: #ffa502; }
        .quality-bad { background: #ff4757; }

        .loader {
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #00d9ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .volume-control input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #00d9ff;
            border-radius: 50%;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }

        .connection-status.online {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            display: block;
        }

        .connection-status.offline {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            display: block;
        }

        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .settings { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .join-panel input { width: 100%; font-size: 20px; }
            .tabs { flex-direction: column; }
            .room-id-display { font-size: 20px; letter-spacing: 3px; }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus"></div>

    <div class="container">
        <header>
            <h1>üì∫ Screen Share</h1>
            <p style="margin-top: 10px; color: #888;">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç</p>
        </header>

        <div class="tabs">
            <div class="tab active" data-mode="host">üñ•Ô∏è –¢—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å</div>
            <div class="tab" data-mode="viewer">üëÅÔ∏è –°–º–æ—Ç—Ä–µ—Ç—å</div>
        </div>

        <div id="hostPanel" class="panel">
            <div class="settings">
                <div class="setting-group">
                    <label>–ö–∞—á–µ—Å—Ç–≤–æ</label>
                    <select id="qualitySelect">
                        <option value="1080">1080p Full HD</option>
                        <option value="720" selected>720p HD</option>
                        <option value="480">480p SD</option>
                        <option value="360">360p –≠–∫–æ–Ω–æ–º–∏—è</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>FPS</label>
                    <select id="fpsSelect">
                        <option value="60">60 FPS</option>
                        <option value="30" selected>30 FPS</option>
                        <option value="15">15 FPS</option>
                        <option value="5">5 FPS</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>–û–ø—Ü–∏–∏</label>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="audioCheck">
                        <span>–ó–≤—É–∫ —Å–∏—Å—Ç–µ–º—ã</span>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-success" id="startBtn">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é</button>
                <button class="btn btn-danger hidden" id="stopBtn">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>

            <div id="streamInfo" class="hidden" style="text-align: center;">
                <p style="margin-bottom: 10px; color: #888;">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</p>
                <div class="room-id-display" id="roomIdDisplay"></div>
                <div class="link-box">
                    <input type="text" id="shareLink" readonly>
                    <button class="btn btn-secondary" id="copyLinkBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="viewers-count" id="viewersCount">üë• –ó—Ä–∏—Ç–µ–ª–µ–π: 0</div>
            </div>

            <div class="status" id="hostStatus">–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é"</div>

            <div class="video-container hidden" id="previewContainer">
                <div class="stats-box" id="hostStats"></div>
                <video id="localVideo" autoplay muted playsinline></video>
                <button class="fullscreen-btn" onclick="toggleFullscreen('previewContainer')">‚õ∂</button>
            </div>
        </div>

        <div id="viewerPanel" class="panel hidden">
            <div class="join-panel" id="joinForm">
                <h2>üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h2>
                <p style="color: #888; margin-bottom: 25px;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É</p>
                <input type="text" id="roomIdInput" placeholder="–ö–æ–¥ –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
                <br>
                <button class="btn btn-primary" id="joinBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                <p class="hint">–ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–Ω—É—é —Å—Å—ã–ª–∫—É ‚Äî –∫–æ–¥ –∏–∑–≤–ª–µ—á—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
            </div>

            <div class="status" id="viewerStatus"></div>

            <div class="video-container hidden" id="remoteContainer">
                <div class="stats-box" id="viewerStats"></div>
                <video id="remoteVideo" autoplay playsinline></video>
                <button class="fullscreen-btn" onclick="toggleFullscreen('remoteContainer')">‚õ∂</button>
            </div>

            <div id="viewerVolumeControl" class="volume-control hidden">
                <span>üîä</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="100">
                <span id="volumeValue">100%</span>
            </div>

            <div class="controls hidden" id="viewerControls">
                <button class="btn btn-danger" id="leaveBtn">üö™ –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAQNel_4CBPzKhIhjwxjKMbtwAT8UFNi10",
            authDomain: "dsfads-2919e.firebaseapp.com",
            databaseURL: "https://dsfads-2919e-default-rtdb.firebaseio.com",
            projectId: "dsfads-2919e",
            storageBucket: "dsfads-2919e.firebasestorage.app",
            messagingSenderId: "17812864018",
            appId: "1:17812864018:web:90d467c59ec37965fceccb",
            measurementId: "G-J3HQJQB5HE"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const ICE_SERVERS = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                {
                    urls: 'turn:openrelay.metered.ca:80',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                }
            ],
            iceCandidatePoolSize: 10
        };

        let localStream = null;
        let peerConnections = {};
        let roomId = null;
        let myPeerId = null;
        let isHost = false;
        let statsInterval = null;
        let roomRef = null;

        function generateId(length) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function extractRoomCode(input) {
            input = input.trim().toUpperCase();
            
            if (input.includes('ROOM=')) {
                const match = input.match(/ROOM=([A-Z0-9]+)/i);
                if (match) {
                    return match[1].toUpperCase().substring(0, 6);
                }
            }
            
            return input.replace(/[^A-Z0-9]/g, '').substring(0, 6);
        }

        db.ref('.info/connected').on('value', (snap) => {
            const statusEl = document.getElementById('connectionStatus');
            if (snap.val() === true) {
                statusEl.className = 'connection-status online';
                statusEl.textContent = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                setTimeout(() => statusEl.style.display = 'none', 2000);
            } else {
                statusEl.className = 'connection-status offline';
                statusEl.textContent = 'üî¥ –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            }
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const mode = tab.dataset.mode;
                document.getElementById('hostPanel').classList.toggle('hidden', mode !== 'host');
                document.getElementById('viewerPanel').classList.toggle('hidden', mode !== 'viewer');
            });
        });

        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        if (roomFromUrl) {
            const code = extractRoomCode(roomFromUrl);
            document.querySelector('[data-mode="viewer"]').click();
            document.getElementById('roomIdInput').value = code;
            setTimeout(() => document.getElementById('joinBtn').click(), 500);
        }

        document.getElementById('startBtn').addEventListener('click', startStreaming);
        document.getElementById('stopBtn').addEventListener('click', stopStreaming);
        document.getElementById('joinBtn').addEventListener('click', joinRoom);
        document.getElementById('leaveBtn').addEventListener('click', leaveRoom);
        document.getElementById('copyLinkBtn').addEventListener('click', copyLink);

        document.getElementById('roomIdInput').addEventListener('paste', (e) => {
            setTimeout(() => {
                const input = document.getElementById('roomIdInput');
                input.value = extractRoomCode(input.value);
            }, 0);
        });

        document.getElementById('roomIdInput').addEventListener('input', (e) => {
            const val = e.target.value;
            if (!val.includes('http') && !val.includes('room=')) {
                e.target.value = val.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 6);
            }
        });

        document.getElementById('roomIdInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('joinBtn').click();
        });

        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            const volume = e.target.value;
            document.getElementById('remoteVideo').volume = volume / 100;
            document.getElementById('volumeValue').textContent = volume + '%';
        });

        async function startStreaming() {
            try {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('hostStatus').innerHTML = '<div class="loader"></div>';

                const quality = parseInt(document.getElementById('qualitySelect').value);
                const fps = parseInt(document.getElementById('fpsSelect').value);
                const withAudio = document.getElementById('audioCheck').checked;

                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        width: { ideal: Math.round(quality * 16 / 9) },
                        height: { ideal: quality },
                        frameRate: { ideal: fps }
                    },
                    audio: withAudio
                });

                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('previewContainer').classList.remove('hidden');

                roomId = generateId(6);
                myPeerId = generateId(12);
                isHost = true;

                roomRef = db.ref('rooms/' + roomId);

                await roomRef.set({
                    host: myPeerId,
                    created: firebase.database.ServerValue.TIMESTAMP,
                    active: true
                });

                roomRef.onDisconnect().remove();

                roomRef.child('viewers').on('child_added', async (snap) => {
                    const viewerId = snap.key;
                    if (viewerId !== myPeerId) {
                        await createOfferForViewer(viewerId);
                    }
                });

                roomRef.child('viewers').on('child_removed', (snap) => {
                    const viewerId = snap.key;
                    if (peerConnections[viewerId]) {
                        peerConnections[viewerId].close();
                        delete peerConnections[viewerId];
                        updateViewersCount();
                    }
                });

                roomRef.child('answers').on('child_added', async (snap) => {
                    const viewerId = snap.key;
                    const answer = snap.val();
                    const pc = peerConnections[viewerId];
                    if (pc && pc.signalingState !== 'stable') {
                        await pc.setRemoteDescription(new RTCSessionDescription(answer));
                    }
                });

                const shareUrl = window.location.origin + window.location.pathname + '?room=' + roomId;
                document.getElementById('shareLink').value = shareUrl;
                document.getElementById('roomIdDisplay').textContent = roomId;
                document.getElementById('streamInfo').classList.remove('hidden');
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.remove('hidden');

                document.getElementById('hostStatus').textContent = '‚úÖ –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞';
                document.getElementById('hostStatus').className = 'status connected';

                startHostStats();

                localStream.getVideoTracks()[0].onended = stopStreaming;

            } catch (err) {
                console.error(err);
                document.getElementById('hostStatus').textContent = '‚ùå ' + (err.message || '–û—à–∏–±–∫–∞');
                document.getElementById('hostStatus').className = 'status error';
                document.getElementById('startBtn').disabled = false;
            }
        }

        async function createOfferForViewer(viewerId) {
            const pc = new RTCPeerConnection(ICE_SERVERS);
            peerConnections[viewerId] = pc;

            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    roomRef.child('hostCandidates/' + viewerId).push(e.candidate.toJSON());
                }
            };

            pc.onconnectionstatechange = () => {
                updateViewersCount();
                if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                    pc.close();
                    delete peerConnections[viewerId];
                    updateViewersCount();
                }
            };

            roomRef.child('viewerCandidates/' + viewerId).on('child_added', async (snap) => {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(snap.val()));
                } catch (e) {}
            });

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            await roomRef.child('offers/' + viewerId).set({
                type: offer.type,
                sdp: offer.sdp
            });

            updateViewersCount();
        }

        function updateViewersCount() {
            const connected = Object.values(peerConnections).filter(pc => 
                pc.connectionState === 'connected' || pc.connectionState === 'connecting'
            ).length;
            document.getElementById('viewersCount').textContent = 'üë• –ó—Ä–∏—Ç–µ–ª–µ–π: ' + connected;
        }

        async function stopStreaming() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};

            if (roomRef) {
                roomRef.off();
                await roomRef.remove();
                roomRef = null;
            }

            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }

            document.getElementById('localVideo').srcObject = null;
            document.getElementById('previewContainer').classList.add('hidden');
            document.getElementById('streamInfo').classList.add('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('hostStatus').textContent = '–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
            document.getElementById('hostStatus').className = 'status';
            document.getElementById('hostStats').innerHTML = '';

            isHost = false;
            roomId = null;
        }

        async function joinRoom() {
            let inputId = document.getElementById('roomIdInput').value;
            inputId = extractRoomCode(inputId);
            document.getElementById('roomIdInput').value = inputId;

            if (inputId.length < 4) {
                document.getElementById('viewerStatus').textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞)';
                document.getElementById('viewerStatus').className = 'status error';
                return;
            }

            try {
                document.getElementById('joinBtn').disabled = true;
                document.getElementById('viewerStatus').innerHTML = '<div class="loader"></div>';

                roomId = inputId;
                myPeerId = generateId(12);

                roomRef = db.ref('rooms/' + roomId);

                const roomSnap = await roomRef.once('value');
                if (!roomSnap.exists() || !roomSnap.val().active) {
                    throw new Error('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞');
                }

                await roomRef.child('viewers/' + myPeerId).set({
                    joined: firebase.database.ServerValue.TIMESTAMP
                });

                roomRef.child('viewers/' + myPeerId).onDisconnect().remove();

                roomRef.child('offers/' + myPeerId).on('value', async (snap) => {
                    const offer = snap.val();
                    if (offer) {
                        await handleOffer(offer);
                    }
                });

                setTimeout(() => {
                    if (!document.getElementById('remoteVideo').srcObject) {
                        document.getElementById('viewerStatus').textContent = '‚ö†Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞...';
                        document.getElementById('viewerStatus').className = 'status warning';
                    }
                }, 5000);

            } catch (err) {
                console.error(err);
                document.getElementById('viewerStatus').textContent = '‚ùå ' + (err.message || '–û—à–∏–±–∫–∞');
                document.getElementById('viewerStatus').className = 'status error';
                document.getElementById('joinBtn').disabled = false;
            }
        }

        async function handleOffer(offer) {
            if (peerConnections['host']) {
                peerConnections['host'].close();
            }

            const pc = new RTCPeerConnection(ICE_SERVERS);
            peerConnections['host'] = pc;

            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    roomRef.child('viewerCandidates/' + myPeerId).push(e.candidate.toJSON());
                }
            };

            pc.ontrack = (e) => {
                const video = document.getElementById('remoteVideo');
                if (video.srcObject !== e.streams[0]) {
                    video.srcObject = e.streams[0];
                    document.getElementById('remoteContainer').classList.remove('hidden');
                    document.getElementById('joinForm').classList.add('hidden');
                    document.getElementById('viewerControls').classList.remove('hidden');
                    document.getElementById('viewerVolumeControl').classList.remove('hidden');
                    document.getElementById('viewerStatus').textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ!';
                    document.getElementById('viewerStatus').className = 'status connected';
                    startViewerStats(pc);
                }
            };

            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                    document.getElementById('viewerStatus').textContent = '‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ';
                    document.getElementById('viewerStatus').className = 'status warning';
                }
            };

            roomRef.child('hostCandidates/' + myPeerId).on('child_added', async (snap) => {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(snap.val()));
                } catch (e) {}
            });

            await pc.setRemoteDescription(new RTCSessionDescription(offer));

            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            await roomRef.child('answers/' + myPeerId).set({
                type: answer.type,
                sdp: answer.sdp
            });
        }

        async function leaveRoom() {
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};

            if (roomRef && myPeerId) {
                roomRef.off();
                await roomRef.child('viewers/' + myPeerId).remove();
                await roomRef.child('answers/' + myPeerId).remove();
                await roomRef.child('viewerCandidates/' + myPeerId).remove();
                roomRef = null;
            }

            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }

            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('remoteContainer').classList.add('hidden');
            document.getElementById('viewerVolumeControl').classList.add('hidden');
            document.getElementById('joinForm').classList.remove('hidden');
            document.getElementById('viewerControls').classList.add('hidden');
            document.getElementById('joinBtn').disabled = false;
            document.getElementById('viewerStatus').textContent = '';
            document.getElementById('viewerStats').innerHTML = '';
        }

        function copyLink() {
            const link = document.getElementById('shareLink').value;
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.getElementById('copyLinkBtn');
                btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => btn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 2000);
            });
        }

        function startHostStats() {
            if (statsInterval) clearInterval(statsInterval);

            statsInterval = setInterval(() => {
                const statsEl = document.getElementById('hostStats');
                const track = localStream?.getVideoTracks()[0];
                if (track) {
                    const s = track.getSettings();
                    const connected = Object.values(peerConnections).filter(pc => 
                        pc.connectionState === 'connected'
                    ).length;

                    statsEl.innerHTML = `
                        <div><span class="quality-dot quality-good"></span>–ê–∫—Ç–∏–≤–Ω–∞</div>
                        <div>üìê ${s.width || '?'}x${s.height || '?'}</div>
                        <div>üé¨ ${Math.round(s.frameRate) || '?'} fps</div>
                        <div>üë• ${connected} –∑—Ä–∏—Ç–µ–ª–µ–π</div>
                    `;
                }
            }, 1000);
        }

        function startViewerStats(pc) {
            if (statsInterval) clearInterval(statsInterval);

            let lastBytes = 0;
            let lastTime = Date.now();

            statsInterval = setInterval(async () => {
                const statsEl = document.getElementById('viewerStats');
                if (!pc) return;

                try {
                    const stats = await pc.getStats();
                    let bytes = 0, fps = 0, width = 0, height = 0;

                    stats.forEach(r => {
                        if (r.type === 'inbound-rtp' && r.kind === 'video') {
                            bytes = r.bytesReceived || 0;
                            fps = r.framesPerSecond || 0;
                            width = r.frameWidth || 0;
                            height = r.frameHeight || 0;
                        }
                    });

                    const now = Date.now();
                    const bitrate = Math.round((bytes - lastBytes) * 8 / (now - lastTime));
                    lastBytes = bytes;
                    lastTime = now;

                    let q = 'quality-good';
                    if (bitrate < 300) q = 'quality-bad';
                    else if (bitrate < 800) q = 'quality-medium';

                    statsEl.innerHTML = `
                        <div><span class="quality-dot ${q}"></span>${pc.connectionState}</div>
                        <div>üìê ${width}x${height}</div>
                        <div>üé¨ ${Math.round(fps)} fps</div>
                        <div>üìä ${bitrate} kbps</div>
                    `;
                } catch (e) {}
            }, 1000);
        }

        function toggleFullscreen(id) {
            const el = document.getElementById(id);
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                el.requestFullscreen();
            }
        }

        window.addEventListener('beforeunload', () => {
            if (isHost) stopStreaming();
            else leaveRoom();
        });
    </script>
</body>
</html>
